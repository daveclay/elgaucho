<!DOCTYPE html>
<html>
<head>
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0, user-scalable=yes" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BmbxuPwQa2lc/FVzBcNJ7UAyJxM6wuqIj61tLrc4wSX0szH/Ev+nYRRuWlolflfl" crossorigin="anonymous">
    <style>
        body {
            background-color: #222323;
            margin: 0;
            padding: 0;
            font-family: Helvetica, sans-serif;
        }
        img {
            user-drag: none;
            user-select: none;
            -moz-user-select: none;
            -webkit-user-drag: none;
            -webkit-user-select: none;
            -ms-user-select: none;
        }
        #table-template {
            display: none;
        }
        #container {
            display: block;
            position: absolute;
            align-items: center;
            justify-content: center;
            touch-action: none;
            z-index: 100;
        }
        .draggable {
            position: absolute;
            touch-action: none;
            user-select: none;
            text-align: center;
            transition: border 0.2s linear;
        }

        /* table types */
        .table {
        }
        .table-content {
            text-align: center;
            display: block;
            position: relative;
        }
        .table .form-content {
            position: relative;
            z-index: 10000;
        }
        .med-circle-table {
            width: 42px;
            height: 42px;
            line-height: 40px;
            border-radius: 50%;
        }
        .small-circle-table {
            width: 27px;
            height: 27px;
            line-height: 27px;
            border-radius: 50%;
        }
        .fire-table {
            width: 68px;
            height: 68px;
            line-height: 68px;
            border-radius: 50%;
        }
        .fire-table .form-content {
            left: 70px;
            top: -76px;
        }
        .small-diamond-table {
            width: 27px;
            height: 27px;
        }
        .large-diamond-table {
            width: 32px;
            height: 32px;
        }
        .diamond-table {
            transform: rotate(45deg);
            border-radius: 5px;
        }
        .diamond-table .table-content {
            position: absolute;
            margin-left: 4px;
            margin-top: 2px;
            transform: rotate(-45deg);
        }
        .diamond-table .form-content {
            left: 70px;
            top: -90px;
        }
        .vip-rect-table {
            width: 34px;
            height: 68px;
            border-radius: 5px;
        }
        .tall-rect-table {
            width: 27px;
            height: 54px;
            border-radius: 5px;
        }
        .tall-rect-table .form-content {
            left: 24px;
            top: -32px;
        }
        .wide-rect-table {
            width: 54px;
            height: 27px;
            border-radius: 5px;
        }
        .wide-rect-table .form-content {
            left: 52px;
            top: -33px;
        }
        .small-square-table {
            width: 27px;
            height: 27px;
            border-radius: 5px;
        }
        .small-square-table .form-content {
            left: 28px;
            top: -33px;
        }
        .med-square-table {
            width: 34px;
            height: 34px;
            border-radius: 5px;
        }
        .med-square-table .form-content {
            left: 34px;
            top: -33px;
        }
        .large-square-table {
            width: 42px;
            height: 42px;
            border-radius: 5px;
        }
        .white-table {
            background-color: rgb(255, 255, 255);
        }
        .green-table {
            background-color: rgb(71, 180, 152);
        }
        .blue-table {
            background-color: rgb(62, 148, 229);
        }
        .togo-table {
            height: 56px;
            width: 42px;
            border-radius: 5px;
        }
        .draggable:active {
            background-color: rgb(255, 255, 52);
        }
        .draggable:hover {
            cursor: pointer;
        }

        /**
            Controls
         */

        #controls {
            position: fixed;
            top: 4px;
            left: 10px;
            z-index: 1000;
        }

        #controls button {
            display: inline-block;
        }

        #table-config {
            display: inline-block;
        }

        #table-config .dropdown {
            display: inline-block;
        }

        .form-content {
            display: none;
        }
    </style>
</head>
<body>
<img src="./gaucho-seating.png" style="position: absolute; z-index: 10000; display: none">
<div id="container">
</div>
<img src="./gaucho-seating-blank.png" id="blank-seating" style="position: absolute; top: 0; left: 0; z-index: 10">
<div id="controls">
    <button class="btn btn-danger" id="reset">Reset</button>
    <div id="table-config">
        <div class="add-table-type dropdown">
            <button class="btn btn-secondary dropdown-toggle"
                    type="button"
                    id="table-type-dropdown-button"
                    data-bs-toggle="dropdown"
                    aria-expanded="false">
                Table Types
            </button>
            <div class="dropdown-menu"
                 id="table-type-dropdown"
                 aria-labelledby="table-type-dropdown-button">
            </div>
        </div>
        <div class="add-table-color dropdown">
            <button class="btn btn-secondary dropdown-toggle"
                    type="button"
                    id="table-color-dropdown-button"
                    data-bs-toggle="dropdown"
                    aria-expanded="false">
                Color
            </button>
            <div class="dropdown-menu"
                 id="table-color-dropdown"
                 aria-labelledby="table-color-dropdown-button">
            </div>
        </div>
        <button class="btn btn-primary" id="addTable">add</button>
    </div>

    <input type="text" id="coords" readonly width="8" style="margin-left: 100px; background-color: #333333; color: gray; display: none">
</div>

<div id="table-template" class="draggable table">
    <div class="table-content">
        <span class="id"></span>
        <div class="form-content">
            <form class="form-inline" role="form">
                <div class="form-group">
                    <input class="tableId" type="text" placeholder="10"/>
                </div>
            </form>
        </div>
    </div>
</div>


</body>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/js/bootstrap.bundle.min.js" integrity="sha384-b5kHyXgcpbZJO/tY9Ul7kGkf1S0CWuKcCD38l8YkeH8z8QjE0GmW1gYU5S9FOnJ0" crossorigin="anonymous"></script>
<script type="application/ecmascript">
    let tableTypes = {
        tallRectTable: {
            style: "tall-rect-table"
        },
        wideRectTable: {
            style: "wide-rect-table"
        },
        togoTable: {
            style: "togo-table"
        },
        fireTable: {
            style: "fire-table"
        },
        smallCircleTable: {
            style: "small-circle-table"
        },
        medCircleTable: {
            style: "med-circle-table"
        },
        smallSquareTable: {
            style: "small-square-table"
        },
        medSquareTable: {
            style: "med-square-table"
        },
        largeSquareTable: {
            style: "large-square-table"
        },
        smallDiamondTable: {
            style: "small-diamond-table diamond-table"
        },
        largeDiamondTable: {
            style: "large-diamond-table diamond-table"
        },
        vipRectTable: {
            style: "vip-rect-table"
        },
    };

    let tableColors = {
        blue: "blue-table",
        green: "green-table",
        white: "white-table"
    }

    let tables = {
        togo: {
            x: 551,	y: 746,
            type: tableTypes.togoTable,
            color: tableColors.blue
        },
        fire: {
            x: 483, y: 338,
            type: tableTypes.fireTable,
            color: tableColors.blue
        },
        table1: {
            x: 306, y: 642,
            type: tableTypes.smallCircleTable,
            color: tableColors.white
        },
        table2: {
            x: 243, y: 642,
            type: tableTypes.smallCircleTable,
            color: tableColors.green
        },
        table3: {
            x: 241, y: 283,
            type: tableTypes.smallCircleTable,
            color: tableColors.white
        },
        table4: {
            x: 308, y: 284,
            type: tableTypes.smallCircleTable,
            color: tableColors.white
        },
        table20: {
            x: 795,	y: 747,
            type: tableTypes.tallRectTable,
            color: tableColors.green
        },
        table21: {
            x: 934, y: 743,
            type: tableTypes.smallSquareTable,
            color: tableColors.white
        },
        table22: {
            x: 887, y: 855,
            type: tableTypes.smallSquareTable,
            color: tableColors.white
        },
        table23: {
            x: 771, y: 851,
            type: tableTypes.largeSquareTable,
            color: tableColors.green
        },
        table60: {
            x: 617,
            y: 187,
            type: tableTypes.medCircleTable,
            color: tableColors.green
        },
        table61: {
            x: 723,
            y: 187,
            type: tableTypes.medCircleTable,
            color: tableColors.green
        },
        table62: {
            x: 827,
            y: 187,
            type: tableTypes.medCircleTable,
            color: tableColors.green
        },
        table63: {
            x: 936,
            y: 187,
            type: tableTypes.medCircleTable,
            color: tableColors.blue
        },
        table30: {
            x: 632,
            y: 297,
            type: tableTypes.smallDiamondTable,
            color: tableColors.white
        },
        table31: {
            x: 770,
            y: 297,
            type: tableTypes.smallDiamondTable,
            color: tableColors.green
        },
        table40: {
            x: 941,
            y: 285,
            type: tableTypes.tallRectTable,
            color: tableColors.green
        },
        table41: {
            x: 941,
            y: 410,
            type: tableTypes.tallRectTable,
            color: tableColors.green
        },
        table42: {
            x: 935,
            y: 547,
            type: tableTypes.medSquareTable,
            color: tableColors.white
        },
        table50: {
            x: 751,
            y: 443,
            type: tableTypes.largeDiamondTable,
            color: tableColors.green
        },
        table51: {
            x: 708,
            y: 580,
            type: tableTypes.smallDiamondTable,
            color: tableColors.green
        },
        table53: {
            x: 654, y: 766,
            type: tableTypes.vipRectTable,
            color: tableColors.green
        },
        table70: {
            x: 1034,	y: 236,
            type: tableTypes.medCircleTable,
            color: tableColors.white
        },
        table71: {
            x: 1033,	y: 356,
            type: tableTypes.medCircleTable,
            color: tableColors.green
        },
        table72: {
            x: 1034,	y: 482,
            type: tableTypes.medCircleTable,
            color: tableColors.green
        },
        table90: {
            x: 389,	y: 519,
            type: tableTypes.tallRectTable,
            color: tableColors.green
        },
        table91: {
            x: 389,	y: 387,
            type: tableTypes.tallRectTable,
            color: tableColors.green
        },
        table101: {
            x: 1291, y: 486,
            type: tableTypes.wideRectTable,
            color: tableColors.white
        },
        table102: {
            x: 1293, y: 362,
            type: tableTypes.largeDiamondTable,
            color: tableColors.white
        },
        table103: {
            x: 1286, y: 249,
            type: tableTypes.wideRectTable,
            color: tableColors.white
        },
        table104: {
            x: 1408,	y: 201,
            type: tableTypes.tallRectTable,
            color: tableColors.white
        },
        table105: {
            x: 1402,	y: 328,
            type: tableTypes.wideRectTable,
            color: tableColors.white
        },
        table106: {
            x: 1402,	y: 423,
            type: tableTypes.wideRectTable,
            color: tableColors.white
        },
        table201: {
            x: 1209, y: 661,
            type: tableTypes.largeDiamondTable,
            color: tableColors.white
        },
        table202: {
            x: 1210, y: 797,
            type: tableTypes.tallRectTable,
            color: tableColors.white
        },
        table203: {
            x: 1053, y: 742,
            type: tableTypes.smallCircleTable,
            color: tableColors.white
        }
    }

    const coords = document.getElementById("coords");
    const container = document.getElementById("container");
    const body = document.getElementsByTagName("body")[0];
    const tableTemplateEl = document.getElementById("table-template");
    const tableTypeDropdownEl = document.getElementById("table-type-dropdown");
    const tableColorDropdownEl = document.getElementById("table-color-dropdown");
    const backgroundEl = document.getElementById("blank-seating");

    function addNewTable() {
        let translateTo = {
            x: window.scrollX + 20,
            y: window.scrollY + 20
        };
        let newTableConfig = {
            x: 0, y: 0, style: "wide-rect-table white-table"
        };
        if (lastDraggedElement) {
            let config = tables[lastDraggedElement.getAttribute("id")];
            newTableConfig.style = config.style;

            translateTo.x = config.x + 20;
            translateTo.y = config.y + 20;
        }
        tables["table1"] = newTableConfig
        let newEl = createTable("table1", newTableConfig)

        // now transform to the mouse
        setTranslate(translateTo.x, translateTo.y, newEl, newTableConfig);
    }

    document.getElementById("addTable").addEventListener("click", e => addNewTable());
    document.getElementById("reset").addEventListener("click", e => {
        location.reload();
    });

    body.addEventListener("touchmove", drag);
    body.addEventListener("mousemove", drag);

    backgroundEl.addEventListener("tap", () => hideCurrentTableForm());
    backgroundEl.addEventListener("click", () => hideCurrentTableForm());

    function buildBaseTableIcon(tableId, config) {
        const tableEl = tableTemplateEl.cloneNode(true);
        tableEl.setAttribute("id", "");
        for (const style of config.type.style.split(" ")) {
            tableEl.classList.add(style);
        }
        tableEl.classList.add(config.color);
        tableEl.setAttribute("id", tableId);

        return tableEl;
    }

    function showTableEditForm(tableEl) {
        currentFormTableElement = tableEl;
        const popoverEl = tableEl.querySelector(".form-content");
        popoverEl.style.display = "block";
    }

    function hideCurrentTableForm() {
        if (currentFormTableElement) {
            const popoverEl = currentFormTableElement.querySelector(".form-content");
            popoverEl.style.display = "none";
        }
    }

    function createTable(tableId, config) {
        const tableEl = buildBaseTableIcon(tableId, config);
        tableEl.style.left = config.x + "px";
        tableEl.style.top = config.y + "px";

        const contentEl = tableEl.querySelector(".table-content");
        const idEl = contentEl.querySelector(".id");
        idEl.innerText = tableId.replace("table", "");

        tableEl.addEventListener("touchstart", dragStart, false);
        tableEl.addEventListener("touchend", dragEnd, false);

        tableEl.addEventListener("mousedown", dragStart, false);
        tableEl.addEventListener("mouseup", dragEnd, false);

        tableEl.addEventListener("dblclick", (e) => {
            const tableEl = findDraggableParent(e.target);
            showTableEditForm(tableEl);
        });

        config.xOffset = 0;
        config.yOffset = 0;

        container.appendChild(tableEl);
        return tableEl;
    }

    for (const [tableId, config] of Object.entries(tables)) {
        createTable(tableId, config)
    }

    function createDropdownItem() {
        const optionDiv = document.createElement("div");
        optionDiv.classList.add("dropdown-item");
        return optionDiv;
    }

    for (const [tableTypeName, tableType] of Object.entries(tableTypes)) {
        const tableTypeIcon = buildBaseTableIcon("tableConfig" + tableTypeName, {
            type: tableType,
            color: tableColors.blue
        })

        tableTypeIcon.classList.remove("draggable");

        const optionDiv = createDropdownItem();
        optionDiv.appendChild(tableTypeIcon);
        tableTypeDropdownEl.appendChild(optionDiv);
    }

    for (const [tableColorName, tableColor] of Object.entries(tableColors)) {
        const colorOption = createDropdownItem();
        colorOption.innerText = tableColorName;
        tableColorDropdownEl.appendChild(colorOption);
    }

    let currentX;
    let currentY;
    let currentDraggedElement;
    let lastDraggedElement;
    let currentFormTableElement;

    function findDraggableParent(el) {
        if (! el) {
            return;
        }
        if (el.classList.contains("draggable")) {
            return el;
        } else {
            return findDraggableParent(el.parentElement);
        }
    }

    function dragStart(e) {
        let target = findDraggableParent(e.target);

        if (currentFormTableElement && target != currentFormTableElement) {
            hideCurrentTableForm();
        }

        if (target && target.classList.contains("draggable")) {
            currentDraggedElement = target;
        } else {
            console.log("Element not draggable", e.target);
            return;
        }

        let config = tables[target.getAttribute("id")];
        if (config) {
            let touch = e.type === "touchstart";
            let x = touch ? e.touches[0].clientX : e.clientX;
            let y = touch ? e.touches[0].clientY : e.clientY;

            config.initialX = x - config.xOffset;
            config.initialY = y - config.yOffset;
        } else {
            console.log("Warning: no config for element with draggable class", target);
        }
    }

    function dragEnd(e) {
        if (currentDraggedElement) {
            lastDraggedElement = currentDraggedElement;
            let config = tables[currentDraggedElement.getAttribute("id")];
            if (config) {
                config.initialX = currentX;
                config.initialY = currentY;
                currentDraggedElement = null;
            } else {
                console.log("Warning: no config for element with draggable class", target);
            }
        }
    }

    function drag(e) {
        if (currentDraggedElement) {
            e.preventDefault();

            let config = tables[currentDraggedElement.getAttribute("id")];
            if (config) {
                if (e.type === "touchmove") {
                    currentX = e.touches[0].clientX - config.initialX;
                    currentY = e.touches[0].clientY - config.initialY;
                } else {
                    currentX = e.clientX - config.initialX;
                    currentY = e.clientY - config.initialY;
                }

                setTranslate(currentX, currentY, currentDraggedElement, config);
            }
        }
    }

    function setTranslate(x, y, el, config) {
        let translate = "translate3d(" + x + "px, " + y + "px, 0)";
        if (el.classList.contains("diamond-table")) {
            el.style.transform = translate + " rotate(45deg) ";
        } else {
            el.style.transform = translate;
        }

        // and remember where we moved it:
        config.xOffset = x;
        config.yOffset = y;

        let bodyRect = document.body.getBoundingClientRect();
        let elRect = el.getBoundingClientRect();
        let location = {
            top: elRect.top - bodyRect.top,
            left: elRect.left - bodyRect.left
        }

        coords.setAttribute("value", "x: " + location.left + ", y: " + location.top + ",");
    }

</script>
</html>