<!DOCTYPE html>
<html>
<head>
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0, user-scalable=yes" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BmbxuPwQa2lc/FVzBcNJ7UAyJxM6wuqIj61tLrc4wSX0szH/Ev+nYRRuWlolflfl" crossorigin="anonymous">
    <style>
    </style>
</head>
<body>
<img src="public/gaucho-seating.png" style="position: absolute; z-index: 10000; display: none">
<div id="container">
</div>
<img src="./gaucho-seating-blank.png" id="blank-seating" style="position: absolute; top: 0; left: 0; z-index: 10">
<div id="controls">
    <button class="btn btn-danger" id="reset">Reset</button>
    <div id="table-config">
        <div class="add-table-type dropdown">
            <button class="btn btn-secondary dropdown-toggle"
                    type="button"
                    id="table-type-dropdown-button"
                    data-bs-toggle="dropdown"
                    aria-expanded="false">
                Table Types
            </button>
            <div class="dropdown-menu"
                 id="table-type-dropdown"
                 aria-labelledby="table-type-dropdown-button">
            </div>
        </div>
        <div class="add-table-color dropdown">
            <button class="btn btn-secondary dropdown-toggle"
                    type="button"
                    id="table-color-dropdown-button"
                    data-bs-toggle="dropdown"
                    aria-expanded="false">
                Color
            </button>
            <div class="dropdown-menu"
                 id="table-color-dropdown"
                 aria-labelledby="table-color-dropdown-button">
            </div>
        </div>
        <button class="btn btn-primary" id="addTable">add</button>
    </div>

    <input type="text" id="coords" readonly width="8" style="margin-left: 100px; background-color: #333333; color: gray; display: none">
</div>

<div id="table-template" class="draggable table">
    <div class="table-content">
        <span class="id"></span>
        <div class="form-content">
            <form class="form-inline" role="form">
                <div class="form-group">
                    <input class="tableId" type="text" placeholder="10"/>
                </div>
            </form>
        </div>
    </div>
</div>


</body>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/js/bootstrap.bundle.min.js" integrity="sha384-b5kHyXgcpbZJO/tY9Ul7kGkf1S0CWuKcCD38l8YkeH8z8QjE0GmW1gYU5S9FOnJ0" crossorigin="anonymous"></script>
<script type="application/ecmascript">

    const coords = document.getElementById("coords");
    const container = document.getElementById("container");
    const body = document.getElementsByTagName("body")[0];
    const tableTemplateEl = document.getElementById("table-template");
    const tableTypeDropdownEl = document.getElementById("table-type-dropdown");
    const tableColorDropdownEl = document.getElementById("table-color-dropdown");
    const backgroundEl = document.getElementById("blank-seating");

    function addNewTable() {
        let translateTo = {
            x: window.scrollX + 20,
            y: window.scrollY + 20
        };
        let newTableConfig = {
            x: 0, y: 0, style: "wide-rect-table white-table"
        };
        if (lastDraggedElement) {
            let config = tables[lastDraggedElement.getAttribute("id")];
            newTableConfig.style = config.style;

            translateTo.x = config.x + 20;
            translateTo.y = config.y + 20;
        }
        tables["table1"] = newTableConfig
        let newEl = createTable("table1", newTableConfig)

        // now transform to the mouse
        setTranslate(translateTo.x, translateTo.y, newEl, newTableConfig);
    }

    document.getElementById("addTable").addEventListener("click", e => addNewTable());
    document.getElementById("reset").addEventListener("click", e => {
        location.reload();
    });

    body.addEventListener("touchmove", drag);
    body.addEventListener("mousemove", drag);

    backgroundEl.addEventListener("tap", () => hideCurrentTableForm());
    backgroundEl.addEventListener("click", () => hideCurrentTableForm());

    function buildBaseTableIcon(tableId, config) {
        const tableEl = tableTemplateEl.cloneNode(true);
        tableEl.setAttribute("id", "");
        for (const style of config.type.style.split(" ")) {
            tableEl.classList.add(style);
        }
        tableEl.classList.add(config.color);
        tableEl.setAttribute("id", tableId);

        return tableEl;
    }

    function showTableEditForm(tableEl) {
        currentFormTableElement = tableEl;
        const popoverEl = tableEl.querySelector(".form-content");
        popoverEl.style.display = "block";
    }

    function hideCurrentTableForm() {
        if (currentFormTableElement) {
            const popoverEl = currentFormTableElement.querySelector(".form-content");
            popoverEl.style.display = "none";
        }
    }

    function createTable(tableId, config) {
        const tableEl = buildBaseTableIcon(tableId, config);
        tableEl.style.left = config.x + "px";
        tableEl.style.top = config.y + "px";

        const contentEl = tableEl.querySelector(".table-content");
        const idEl = contentEl.querySelector(".id");
        idEl.innerText = tableId.replace("table", "");

        tableEl.addEventListener("touchstart", dragStart, false);
        tableEl.addEventListener("touchend", dragEnd, false);

        tableEl.addEventListener("mousedown", dragStart, false);
        tableEl.addEventListener("mouseup", dragEnd, false);

        tableEl.addEventListener("dblclick", (e) => {
            const tableEl = findDraggableParent(e.target);
            showTableEditForm(tableEl);
        });

        config.xOffset = 0;
        config.yOffset = 0;

        container.appendChild(tableEl);
        return tableEl;
    }

    for (const [tableId, config] of Object.entries(tables)) {
        createTable(tableId, config)
    }

    function createDropdownItem() {
        const optionDiv = document.createElement("div");
        optionDiv.classList.add("dropdown-item");
        return optionDiv;
    }

    for (const [tableTypeName, tableType] of Object.entries(tableTypes)) {
        const tableTypeIcon = buildBaseTableIcon("tableConfig" + tableTypeName, {
            type: tableType,
            color: tableColors.blue
        })

        tableTypeIcon.classList.remove("draggable");

        const optionDiv = createDropdownItem();
        optionDiv.appendChild(tableTypeIcon);
        tableTypeDropdownEl.appendChild(optionDiv);
    }

    for (const [tableColorName, tableColor] of Object.entries(tableColors)) {
        const colorOption = createDropdownItem();
        colorOption.innerText = tableColorName;
        tableColorDropdownEl.appendChild(colorOption);
    }

    let currentX;
    let currentY;
    let currentDraggedElement;
    let lastDraggedElement;
    let currentFormTableElement;

    function findDraggableParent(el) {
        if (! el) {
            return;
        }
        if (el.classList.contains("draggable")) {
            return el;
        } else {
            return findDraggableParent(el.parentElement);
        }
    }

    function dragStart(e) {
        let target = findDraggableParent(e.target);

        if (currentFormTableElement && target != currentFormTableElement) {
            hideCurrentTableForm();
        }

        if (target && target.classList.contains("draggable")) {
            currentDraggedElement = target;
        } else {
            console.log("Element not draggable", e.target);
            return;
        }

        let config = tables[target.getAttribute("id")];
        if (config) {
            let touch = e.type === "touchstart";
            let x = touch ? e.touches[0].clientX : e.clientX;
            let y = touch ? e.touches[0].clientY : e.clientY;

            config.initialX = x - config.xOffset;
            config.initialY = y - config.yOffset;
        } else {
            console.log("Warning: no config for element with draggable class", target);
        }
    }

    function dragEnd(e) {
        if (currentDraggedElement) {
            lastDraggedElement = currentDraggedElement;
            let config = tables[currentDraggedElement.getAttribute("id")];
            if (config) {
                config.initialX = currentX;
                config.initialY = currentY;
                currentDraggedElement = null;
            } else {
                console.log("Warning: no config for element with draggable class", target);
            }
        }
    }

    function drag(e) {
        if (currentDraggedElement) {
            e.preventDefault();

            let config = tables[currentDraggedElement.getAttribute("id")];
            if (config) {
                if (e.type === "touchmove") {
                    currentX = e.touches[0].clientX - config.initialX;
                    currentY = e.touches[0].clientY - config.initialY;
                } else {
                    currentX = e.clientX - config.initialX;
                    currentY = e.clientY - config.initialY;
                }

                setTranslate(currentX, currentY, currentDraggedElement, config);
            }
        }
    }

    function setTranslate(x, y, el, config) {
        let translate = "translate3d(" + x + "px, " + y + "px, 0)";
        if (el.classList.contains("diamond-table")) {
            el.style.transform = translate + " rotate(45deg) ";
        } else {
            el.style.transform = translate;
        }

        // and remember where we moved it:
        config.xOffset = x;
        config.yOffset = y;

        let bodyRect = document.body.getBoundingClientRect();
        let elRect = el.getBoundingClientRect();
        let location = {
            top: elRect.top - bodyRect.top,
            left: elRect.left - bodyRect.left
        }

        coords.setAttribute("value", "x: " + location.left + ", y: " + location.top + ",");
    }

</script>
</html>